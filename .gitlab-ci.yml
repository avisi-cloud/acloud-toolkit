stages:
  - test
  - review
  - build
  - release

include:
  - project: ame/ci
    file: /.templates/docker-20.yaml
  - project: ame/ci
    file: /.templates/danger.yaml
  - project: ame/ci
    file: /.templates/golang.yaml
  - project: ame/ci
    file: /.templates/sonar-qube.yaml

variables:
  BRANCH: $CI_COMMIT_BRANCH
  COMMIT: $CI_COMMIT_SHA
  VERSION: $CI_COMMIT_TAG

go:test:
  extends: .go:test
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  before_script:
    - mkdir -p .go
    - go mod download
  cache:
    paths:
      - .go/pkg/mod/
  stage: test

sonar:scanner:
  extends: .sonar:scanner
  stage: test
  only: [master,tags]
  allow_failure: true

go:code_review:
  stage: review
  extends: .go:code_review

code_navigation:
  extends: .go:code_navigation
  stage: build
  needs: []

go:build:
  extends: .go:make:build
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    policy: pull
    paths:
      - .go/pkg/mod/
  stage: build
  before_script:
    - mkdir -p .go
    - go mod download
  script:
    - make linux
    - make darwin
  artifacts:
    paths:
      - bin/acloud-toolkit-linux-amd64
      - bin/acloud-toolkit-darwin-amd64

release:
  stage: release
  extends: .go:release-docker
  only:
    - tags
