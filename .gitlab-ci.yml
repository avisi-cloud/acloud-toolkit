stages:
  - lint
  - test
  - build
  - publish

include:
  - 'https://gitlab.avisi.cloud/ame/ci/raw/master/.templates/docker.yaml'
  - 'https://gitlab.avisi.cloud/ame/ci/raw/master/.templates/golang.yaml'

cache:
  paths:
    - /go/pkg/mod

variables:
  VERSION: $CI_COMMIT_TAG
  IMAGE_NAME: 'library/csi-snapshot-utils'

go:test:
  extends: .go:test
  stage: test

go:lint:
  extends: .go:make:golint
  stage: lint
  allow_failure: true

go:race_detector:
  extends: .go:make:race_detector
  stage: test
  allow_failure: true

docker:build-pr:
  extends: .docker:build-and-push
  stage: build
  tags: [docker]
  except: [tags]

docker:build:
  extends: .docker:build-and-push-version
  stage: build
  only: [tags]
  tags: [docker]

docker:lint:
  stage: lint
  extends: .docker:lint
  allow_failure: true

docker:promote:
  extends: .docker:promote-to-registry
  stage: publish
  only: [tags]
  tags: [docker]
